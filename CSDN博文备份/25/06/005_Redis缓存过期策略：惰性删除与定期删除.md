# Redis缓存过期策略：惰性删除与定期删除

> 原创 于 2025-06-13 13:30:46 发布 · 公开 · 737 阅读 · 12 · 8 · CC 4.0 BY-SA版权 版权声明：本文为博主原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接和本声明。
> 文章链接：https://blog.csdn.net/lyh2004_08/article/details/148629974

**目录**

[TOC]

1. ##  **惰性删除** 

   > 

   -  **一句话描述：** 设置该key过期时间后，我们不去管它。当需要该key时，我们检查其是否过期。如果过期，我们就删掉它；反之，返回该key。

   -  **优点：** 对CPU友好。只有被访问的Key才可能触发删除操作，避免了不必要的CPU消耗。

   -  **缺点：** 对内存不友好。如果大量已过期的Key永远不会再被访问，它们会一直占用宝贵的内存空间，导致“内存泄漏”（非严格意义上的泄漏，只是无效数据堆积）。

2. ##  **定期删除** 

   > 

   -  **原理：** Redis会 `周期性地` 、 `随机地` 从设置了过期时间的Key集合中抽取一部分进行检查，并删除其中已过期的Key。

   -  **模式：** 
   > 
   >   -  **SLOW模式：** `Redis的核心定时任务` 。
   > 
   >     - SLOW模式，是定时任务，执行频率默认为10hz，每次不超过25ms
   > 
   >     - 可以通过修改配置文件 `redis.conf` 的 `hz` 选项来调整这个次数
   > 
   >   -  **FAST模式：** 
   > 
   >     - 执行频率不固定，每次事件循环会尝试执行，但两次间隔不低于2ms，每次耗时不超过1ms
   > 
   >     - 耗时和间隔短的原因：尽量少地占用进程资源，不影响到主进程
   > 
   > 

   -  **优点：** 一定程度上缓解了惰性删除可能导致的内存浪费问题

   -  **缺点：** 难以精确控制删除的量和时机。删除频率过高影响性能，过低则内存回收不及时

>  **<span style="background-color:null">Redis的过期删除策略是：惰性删除 + 定期删除两种策略配合使用。</span>** 

---

##  **通俗易懂的类比（示意图概念）** 

1.  **Redis数据库 类比 超市货架：** 

   -  **Key：** 商品。

   -  **过期时间：** 商品的保质期标签。

   -  **惰性删除：** `顾客（客户端请求）` 拿起商品准备买时，收银员检查保质期。过期了，收银员扔掉它并告诉顾客不能买（删除Key并返回nil）。没过期，正常结账（返回数据）。

   -  **定期删除 (SLOW)：** `夜班理货员（SLOW模式任务）` 每隔一段时间（比如每小时）推着小车在货架上 `随机抽查` 一批快到保质期或贴了保质期标签的商品，把过期的挑出来扔掉。

   -  **定期删除 (FAST)：** `机动清洁员（FAST模式任务）` 在超市人流较少的时候（事件循环间隙），快速地在几个货架间穿梭，看到 `刚过期` 或 `明显过期` 的商品就立刻捡走扔掉（耗时短，频率高但不固定）。

1.  **示意图概念：** 

   ```cobol
   +---------------------------------------------+
   |             Redis 实例 (超市)                |
   |                                             |
   |  +-------+   +--------------------------+   |
   |  | 内存  |   |  Keys with Expire (货架区)|   |
   |  | (仓库)|   | +----------------------+ |   |
   |  |       |   | |  过期Key A (过期牛奶) | |   |
   |  |       |   | +----------------------+ |   |
   |  | 满了! |   | | 未过期Key B (陈年饼干)| |   |
   |  +-------+   | +----------------------+ |   |
   |              | |  未过期Key C (新面包) | |   |
   |              | +----------------------+ |   |
   |              +--------------------------+   |
   |                                             |
   |  操作:                                      |
   |  1. (惰性) 顾客买面包: 检查C -> 有效 -> 卖出  |
   |  2. (惰性) 顾客买牛奶: 检查A -> 过期 -> 扔掉  |
   |  3. (定期-SLOW) 理货员抽查: 随机拿B和A -> 扔A |
   |  4. (定期-FAST) 清洁员: 快速捡起地上的过期货   |
   |  5. (淘汰) 仓库满: 经理按volatile-lru规则扔B |
   +---------------------------------------------+
   ```

---

## 拓展

Q： **如果Redis里有很多设置了过期时间但很久都不会被访问的Key（比如一些临时的、一次性的数据），定期删除也没来得及清理完，最终内存满了怎么办？** 

> A：这涉及到Redis的内存管理机制了。过期策略（惰性+定期）主要负责清理 `已经过期` 的Key。当内存使用达到 `maxmemory` 配置的限制时，Redis会触发 `内存淘汰策略` （Eviction Policy）。

Q： **那你知道有哪些内存淘汰策略吗？它们和过期策略是什么关系？** 

> A： [Redis内存淘汰策略（精简速记版）-CSDN博客](https://blog.csdn.net/lyh2004_08/article/details/148630509) 